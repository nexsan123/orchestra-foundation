# 🎼 Orchestra 皇上使用手册

> 版本：v1.0
> 日期：2026-01-23
> 用途：从皇上视角，展示 Orchestra 完整使用流程

---

## 📌 全局流程总览

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Orchestra 完整流程                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐  │
│  │  Plan   │────▶│  Spec   │────▶│  Code   │────▶│  Test   │────▶│ Review  │  │
│  │  Agent  │     │  Agent  │     │  Agent  │     │  Agent  │     │  Agent  │  │
│  │ 翰林学士 │     │ 工部尚书 │     │ 工部侍郎 │     │ 工部主事 │     │ 都察院  │  │
│  └────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘  │
│       │               │               │               │               │        │
│       ▼               ▼               ▼               ▼               ▼        │
│   Plan Report    Tech Spec        代码产出        测试报告        审查通过     │
│   modules.yaml   契约层定义       实现层代码      质量评分        ✅ 交付      │
│                                                                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                              辅助 Skill（全程支持）                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   🔭 钦天监（project-scanner）    → 扫描项目，提供真实信息                      │
│   📐 将作监（module-planner）     → 规划模块，检查命名                          │
│   📜 史官（dialogue-archivist）   → 记录全程，留痕可查                          │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---


## 🎼 Conductor Agent（内阁首辅）

Conductor Agent 是 Orchestra 的总指挥，负责协调所有 Agent 的工作。

### 核心职责

| 职责 | 说明 |
|------|------|
| **流程协调** | 协调各 Agent 之间的工作交接 |
| **状态监控** | 实时监控项目状态，及时发现问题 |
| **问题路由** | 分析用户问题，路由到对应 Agent 处理 |
| **异常处理** | 处理流程中的各种异常情况 |
| **多项目管理** | 支持多项目并行开发，统一监控 |

### 问题路由示例

```
用户提问 → Conductor 分析 → 路由到对应 Agent

• "这个功能是做什么的？" → Review Agent（项目说明）
• "有个 bug..."          → 分析层面 → Code/Test/Spec/Plan Agent
• "加个功能..."          → 评估影响 → 确定起始阶段
• "现在进展怎样？"        → Conductor 直接回答
```

### 多项目并行

```
┌─────────────────────────────────────────────────────────────────┐
│  终端 1: 总控台                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  🎼 Orchestra 总控台                                       │  │
│  │  PRJ-001 | 电商系统 | 60% | Code Agent                     │  │
│  │  PRJ-002 | 博客系统 | 80% | Test Agent                     │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌─────────────────────┐  ┌─────────────────────┐               │
│  │ 终端 2: PRJ-001     │  │ 终端 3: PRJ-002     │               │
│  │ [Code Agent 工作中] │  │ [Test Agent 工作中] │               │
│  └─────────────────────┘  └─────────────────────┘               │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎯 三种使用场景

```
┌─────────────────────────────────────────────────────────────────┐
│                      场景选择入口                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  皇上说："我要..."                                               │
│       │                                                         │
│       ├──▶ "做一个新项目" ──────▶ 场景一：新项目开发             │
│       │                                                         │
│       ├──▶ "给现有项目加功能" ──▶ 场景二：功能迭代               │
│       │                                                         │
│       └──▶ "重构这个老项目" ──▶ 场景三：项目重塑                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📋 场景一：新项目开发（完整流程）

### 阶段 0：皇上发起

```
┌─────────────────────────────────────────────────────────────────┐
│  皇上："我想做一个任务管理 App，要支持 Web 和手机端"             │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
```

### 阶段 1：Plan Agent（需求规划）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Plan Agent · 翰林学士                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Step 1.1: 史官开始记录                                                     │
│  ──────────────────────                                                     │
│  调用: dialogue-archivist.start_project("任务管理App")                      │
│  返回: project_id, record_id                                               │
│                                                                             │
│  Step 1.2: 需求采集（与皇上对话）                                           │
│  ──────────────────────────────                                             │
│  Plan Agent: "请问这个任务管理 App 主要给谁用？"                            │
│  皇上: "给我的团队用，大概 10 个人"                                         │
│                                                                             │
│  Plan Agent: "需要哪些核心功能？"                                           │
│  皇上: "创建任务、分配任务、设置截止日期、看板视图"                         │
│                                                                             │
│  Plan Agent: "需要用户登录吗？"                                             │
│  皇上: "要，用邮箱登录"                                                     │
│                                                                             │
│  Step 1.3: 生成 Plan Report                                                │
│  ─────────────────────────                                                  │
│  产出:                                                                      │
│    - 功能列表（P0/P1/P2 优先级）                                            │
│    - 目标平台：Web + Mobile                                                 │
│    - 用户规模：10 人团队                                                    │
│    - 初步模块划分                                                           │
│                                                                             │
│  Step 1.4: 皇上确认                                                        │
│  ─────────────────                                                          │
│  Plan Agent: "以上理解是否正确？"                                           │
│  皇上: "✅ 确认"                                                            │
│                                                                             │
│  Step 1.5: 史官记录完成                                                    │
│  ─────────────────────                                                      │
│  调用: dialogue-archivist.complete_stage("plan")                           │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  产出物:                                                                    │
│    📄 Plan Report（需求报告）                                               │
│    📄 初步 modules.yaml（模块划分草案）                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
```

### 阶段 2：Spec Agent（技术规格设计）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Spec Agent · 工部尚书                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Step 2.1: 接收 Plan Report                                                │
│  ────────────────────────                                                   │
│  输入: Plan Report + 初步 modules.yaml                                     │
│  调用: dialogue-archivist.start_stage("spec")                              │
│                                                                             │
│  Step 2.2: 调用将作监规划模块                                              │
│  ──────────────────────────                                                 │
│  调用: module-planner.plan_modules(features)                               │
│  返回:                                                                      │
│    - 完整模块树                                                             │
│    - 依赖关系图                                                             │
│    - 开发顺序建议                                                           │
│                                                                             │
│  Step 2.3: 设计契约层（草案）📝                                            │
│  ─────────────────────────────                                              │
│  设计内容:                                                                  │
│    - interface/type 定义（User, Task, Project...）                         │
│    - API 接口设计（POST /tasks, GET /tasks/:id...）                        │
│    - 数据库模型（users, tasks, projects 表）                               │
│    - 模块间依赖关系                                                         │
│                                                                             │
│  【注意】此阶段只是设计草案，还未验证能否编译通过                           │
│                                                                             │
│  Step 2.4: 生成 Tech Spec                                                  │
│  ─────────────────────                                                      │
│  产出:                                                                      │
│    - 完整 modules.yaml                                                     │
│    - Tech Spec 文档（接口定义、类型定义、数据模型）                         │
│                                                                             │
│  Step 2.5: 皇上确认设计草案                                                │
│  ─────────────────────────                                                  │
│  Spec Agent: "以下是技术设计草案，Code Agent 将实现并验证后再锁定"          │
│  皇上: "✅ 确认设计方向"                                                    │
│                                                                             │
│  【注意】此时不锁定！锁定在 Code Agent 实现并验证通过后进行                 │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  产出物:                                                                    │
│    📄 modules.yaml（完整版）                                                │
│    📄 Tech Spec（契约层设计草案）                                           │
│    📝 状态：设计草案，待 Code Agent 实现验证后锁定                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
```

### 阶段 3：Code Agent（代码开发）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Code Agent · 工部侍郎                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Step 3.1: 接收 Tech Spec + modules.yaml                                   │
│  ────────────────────────────────────                                       │
│  调用: dialogue-archivist.start_stage("code")                              │
│  输入: Tech Spec（契约设计草案）+ modules.yaml                             │
│                                                                             │
│  Step 3.2: 调用将作监检查命名                                              │
│  ──────────────────────────────                                             │
│  调用: module-planner.check_naming(modules)                                │
│  返回: 命名检查结果                                                        │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│  ║              Phase A: 契约层实现（按依赖顺序）                       ║   │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Step 3.3: shared 契约实现                                                 │
│  ─────────────────────────                                                  │
│    ┌─────────────────────────────────────────────────────────┐             │
│    │  shared-coder 创建（只有签名，没有实现）：               │             │
│    │    - types/index.ts（User, Task, Project...）          │             │
│    │    - interfaces/index.ts（IUserService...）            │             │
│    │    - configs/index.ts                                  │             │
│    │                                                         │             │
│    │  验证: npx tsc --noEmit                                │             │
│    │  通过: ✅ shared 契约就绪                               │             │
│    └─────────────────────────────────────────────────────────┘             │
│                          │                                                  │
│                          ▼                                                  │
│  Step 3.4: backend 契约实现                                                │
│  ──────────────────────────                                                 │
│    ┌─────────────────────────────────────────────────────────┐             │
│    │  backend-coder 创建（引用已就绪的 shared 类型）：       │             │
│    │    - models/schema.prisma（数据模型）                  │             │
│    │    - api/routes.ts（API 路由签名）                     │             │
│    │    - api/types.ts（请求/响应类型）                     │             │
│    │    - services/interfaces/（服务接口签名）              │             │
│    │                                                         │             │
│    │  验证: npx tsc --noEmit                                │             │
│    │  通过: ✅ backend 契约就绪                              │             │
│    └─────────────────────────────────────────────────────────┘             │
│                          │                                                  │
│                          ▼                                                  │
│  Step 3.5: 各端契约实现（可并行）                                          │
│  ────────────────────────────────                                           │
│    ┌─────────────────────────────────────────────────────────┐             │
│    │  web/mobile/desktop-coder 创建：                        │             │
│    │    - services/api.ts（API 调用签名）                   │             │
│    │    - hooks/interfaces.ts（Hook 接口）                  │             │
│    │    - components/types.ts（组件 Props 类型）            │             │
│    │                                                         │             │
│    │  验证: npx tsc --noEmit                                │             │
│    │  通过: ✅ 各端契约就绪                                  │             │
│    └─────────────────────────────────────────────────────────┘             │
│                          │                                                  │
│                          ▼                                                  │
│  Step 3.6: 皇上确认契约层 → 🔒 锁定                                        │
│  ──────────────────────────────────                                         │
│  Code Agent: "启奏皇上，契约层已全部实现并通过编译验证，请审阅"            │
│  皇上: "✅ 确认"                                                            │
│  调用: dialogue-archivist.lock_contract(all_contracts)                     │
│  状态: 🔒 契约层已锁定（基于真实代码，不是纸上设计）                       │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│  ║              Phase B: 实现层开发（按功能垂直）                       ║   │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Step 3.7: 后端基础实现                                                    │
│  ─────────────────────────                                                  │
│    ┌─────────────────────────────────────────────────────────┐             │
│    │  backend-coder 填充实现：                               │             │
│    │    - 数据库初始化（prisma migrate）                    │             │
│    │    - 基础中间件（认证、日志、错误处理）                │             │
│    │    - 认证服务实现                                       │             │
│    │                                                         │             │
│    │  验证: npm test（后端基础测试通过）                    │             │
│    └─────────────────────────────────────────────────────────┘             │
│                          │                                                  │
│                          ▼                                                  │
│  Step 3.8: 功能垂直开发（按功能逐个完成）                                  │
│  ────────────────────────────────────────                                   │
│    ┌─────────────────────────────────────────────────────────┐             │
│    │  功能 1: 用户认证                                       │             │
│    │    - backend-coder: 填充认证 API 逻辑                  │             │
│    │    - shared-coder: 填充认证 hooks 实现                 │             │
│    │    - web-coder: 填充登录页面组件                       │             │
│    │    - mobile-coder: 填充登录屏幕组件                    │             │
│    │    - 验证: npm test                                    │             │
│    └─────────────────────────────────────────────────────────┘             │
│                          │                                                  │
│                          ▼                                                  │
│    ┌─────────────────────────────────────────────────────────┐             │
│    │  功能 2: 任务管理                                       │             │
│    │    - backend-coder: 填充任务 CRUD 逻辑                 │             │
│    │    - shared-coder: 填充任务 hooks 实现                 │             │
│    │    - web/mobile-coder: 填充任务界面                    │             │
│    │    - 验证: npm test                                    │             │
│    └─────────────────────────────────────────────────────────┘             │
│                          │                                                  │
│                          ▼                                                  │
│                       ... 更多功能 ...                                      │
│                                                                             │
│  Step 3.9: 调用钦天监最终扫描                                              │
│  ──────────────────────────────                                             │
│  调用: project-scanner.scan_project(deep=true)                             │
│  返回: 扫描 ID + 质量报告                                                  │
│                                                                             │
│  Step 3.10: 生成开发报告                                                   │
│  ──────────────────────                                                     │
│  产出:                                                                      │
│    - 完成的模块列表                                                         │
│    - 契约层锁定记录                                                         │
│    - 依赖关系                                                               │
│    - 已知问题                                                               │
│    - 钦天监扫描 ID                                                         │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  产出物:                                                                    │
│    📦 packages/shared（共享代码）                                           │
│    📦 packages/backend（后端代码）                                          │
│    📦 packages/web（Web 前端代码）                                          │
│    📦 packages/mobile（移动端代码）                                         │
│    🔒 契约层锁定记录                                                        │
│    📄 开发报告                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
```

### 阶段 4：Test Agent（验收测试）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Test Agent · 工部主事                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Step 4.1: 接收代码产出                                                    │
│  ────────────────────                                                       │
│  调用: dialogue-archivist.start_stage("test")                              │
│  输入: 代码包 + modules.yaml + Tech Spec + 开发报告                        │
│                                                                             │
│  Step 4.2: 五层验收（逐层执行）                                            │
│  ──────────────────────────────                                             │
│                                                                             │
│    ┌─────────────────────────────────────────────────────────┐             │
│    │  Layer 1: 编译验证                                      │             │
│    │    - npx tsc --noEmit                                  │             │
│    │    - npx eslint .                                      │             │
│    │    → 失败立即打回 Code Agent                           │             │
│    └─────────────────────────────────────────────────────────┘             │
│                          │ 通过                                             │
│                          ▼                                                  │
│    ┌─────────────────────────────────────────────────────────┐             │
│    │  Layer 2: 单元测试                                      │             │
│    │    - npm test --coverage                               │             │
│    │    - 通过率 ≥ 80%？                                    │             │
│    └─────────────────────────────────────────────────────────┘             │
│                          │ 通过                                             │
│                          ▼                                                  │
│    ┌─────────────────────────────────────────────────────────┐             │
│    │  Layer 3: 集成测试                                      │             │
│    │    - 启动后端: npm run start:dev                       │             │
│    │    - 运行 e2e: npm run test:e2e                        │             │
│    │    - 核心流程 100%？                                   │             │
│    └─────────────────────────────────────────────────────────┘             │
│                          │ 通过                                             │
│                          ▼                                                  │
│    ┌─────────────────────────────────────────────────────────┐             │
│    │  Layer 4: 质量检查                                      │             │
│    │    - 钦天监: scan_project()                            │             │
│    │    - 将作监: check_naming_batch()                      │             │
│    │    - 无严重问题？                                      │             │
│    └─────────────────────────────────────────────────────────┘             │
│                          │ 通过                                             │
│                          ▼                                                  │
│    ┌─────────────────────────────────────────────────────────┐             │
│    │  Layer 5: 规格符合                                      │             │
│    │    - 对比 Tech Spec                                    │             │
│    │    - 契约层是否被破坏？                                │             │
│    │    - 功能是否完整？                                    │             │
│    └─────────────────────────────────────────────────────────┘             │
│                                                                             │
│  Step 4.3: 生成测试报告 + 判定                                             │
│  ────────────────────────────────                                           │
│                                                                             │
│    ┌─────────────────────────────────────────────────────────┐             │
│    │                      判定结果                           │             │
│    ├─────────────────────────────────────────────────────────┤             │
│    │                                                         │             │
│    │  PASS           → 全部通过，交付 Review Agent          │             │
│    │  CONDITIONAL    → 有警告，带警告交付 Review Agent      │             │
│    │  FAIL           → 未通过，打回 Code Agent              │             │
│    │                                                         │             │
│    └─────────────────────────────────────────────────────────┘             │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  产出物:                                                                    │
│    📄 测试报告（通过率、覆盖率、质量评分）                                  │
│    🏷️ 判定结果（PASS / CONDITIONAL / FAIL）                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                │
                    ┌───────────┴───────────┐
                    │                       │
                    ▼                       ▼
              PASS/CONDITIONAL            FAIL
                    │                       │
                    ▼                       ▼
              Review Agent            Code Agent（修复）
```

### 阶段 4.5：失败时的优化循环（Ralph Loop）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Test FAIL → Code 修复循环                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌──────────────────────────────────────────────────────────────────┐    │
│    │                                                                  │    │
│    │   Test Agent: FAIL                                              │    │
│    │       │                                                          │    │
│    │       │ 失败报告（具体问题 + 修复建议）                          │    │
│    │       ▼                                                          │    │
│    │   Code Agent: 修复                                              │    │
│    │       │                                                          │    │
│    │       │ 分析问题 → 修改代码 → 重新验证                          │    │
│    │       │                                                          │    │
│    │       │ 【真实执行】                                            │    │
│    │       │   - npm test（真跑）                                    │    │
│    │       │   - tsc --noEmit（真编译）                              │    │
│    │       │                                                          │    │
│    │       ▼                                                          │    │
│    │   结果判断                                                       │    │
│    │       │                                                          │    │
│    │       ├── 通过 → 提交给 Test Agent 正式验收                     │    │
│    │       │                                                          │    │
│    │       └── 失败 → 继续修复（iterations < max?）                  │    │
│    │               │                                                  │    │
│    │               ├── YES → 继续循环                                │    │
│    │               │                                                  │    │
│    │               └── NO → 上报皇上"卡住了"                         │    │
│    │                                                                  │    │
│    └──────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  安全机制:                                                                  │
│    - max_iterations: 20                                                    │
│    - stuck_behavior: 上报皇上，请求指示                                    │
│    - 契约层保护: 修复不能破坏契约                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 阶段 5：Review Agent（人工审查）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Review Agent · 都察院                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Step 5.1: 接收测试通过的代码                                              │
│  ────────────────────────────                                               │
│  输入: 代码包 + 测试报告 + 质量评分                                        │
│                                                                             │
│  Step 5.2: 人工审查要点                                                    │
│  ─────────────────────                                                      │
│  Review Agent 向皇上报告:                                                   │
│    - 代码结构是否清晰                                                       │
│    - 关键逻辑是否正确                                                       │
│    - 是否有安全隐患                                                         │
│    - 是否符合皇上预期                                                       │
│                                                                             │
│  Step 5.3: 皇上最终确认                                                    │
│  ─────────────────────                                                      │
│  皇上: "✅ 通过" / "❌ 有问题，需要改..."                                  │
│                                                                             │
│  Step 5.4: 交付                                                            │
│  ──────────                                                                 │
│  调用: dialogue-archivist.complete_project()                               │
│  产出: 可部署的完整项目                                                    │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  产出物:                                                                    │
│    ✅ 审查通过的完整项目                                                    │
│    📄 项目完成报告                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📋 场景二：功能迭代（增量流程）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         功能迭代流程                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  皇上: "给现有项目加一个'项目分组'功能"                                     │
│                                                                             │
│  Step 1: 钦天监扫描现有项目                                                │
│  ──────────────────────────                                                 │
│  调用: project-scanner.scan_project()                                      │
│  获取: 现有结构、模块清单、依赖关系                                        │
│                                                                             │
│  Step 2: Spec Agent 设计新功能（增量）                                     │
│  ────────────────────────────────────                                       │
│  设计:                                                                      │
│    - 新增 interface: ProjectGroup                                          │
│    - 新增 API: /project-groups/*                                           │
│    - 新增模块: projectGroupService, projectGroupHook                       │
│  检查:                                                                      │
│    - 与现有契约兼容？                                                       │
│    - 需要修改现有契约？→ 需皇上许可                                        │
│                                                                             │
│  Step 3: Code Agent 开发新功能                                             │
│  ────────────────────────────                                               │
│  规则:                                                                      │
│    - 只开发新增模块                                                         │
│    - 不修改现有模块（除非必要且有记录）                                     │
│    - 现有测试必须继续通过                                                   │
│                                                                             │
│  Step 4: Test Agent 增量验收                                               │
│  ────────────────────────────                                               │
│  验证:                                                                      │
│    - 新功能测试通过                                                         │
│    - 现有功能回归测试通过（确保没破坏）                                     │
│    - 契约层未被破坏                                                         │
│                                                                             │
│  Step 5: Review + 交付                                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📋 场景三：项目重塑（重构流程）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         项目重塑流程                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  皇上: "这个老项目代码太乱了，帮我重构成模块化结构"                         │
│                                                                             │
│  Step 1: 钦天监深度扫描                                                    │
│  ─────────────────────                                                      │
│  调用: project-scanner.scan_project(deep=true)                             │
│  调用: project-scanner.refactor_analysis()                                 │
│  获取:                                                                      │
│    - 现有代码结构                                                           │
│    - 技术债务评估                                                           │
│    - 重构建议                                                               │
│                                                                             │
│  Step 2: Spec Agent 设计目标结构                                           │
│  ────────────────────────────────                                           │
│  产出:                                                                      │
│    - 目标 modules.yaml                                                     │
│    - 迁移映射（旧 → 新）                                                   │
│    - 分批次计划                                                             │
│                                                                             │
│  Step 3: Code Agent 分批次重构                                             │
│  ────────────────────────────────                                           │
│                                                                             │
│    ┌─────────────────────────────────────────────────────────┐             │
│    │  Batch 1: 基础层                                        │             │
│    │    - 迁移 types, utils, configs                        │             │
│    │    - 验证编译通过                                       │             │
│    │    - 验证现有功能不受影响                               │             │
│    │    - 皇上确认: ✅                                       │             │
│    └─────────────────────────────────────────────────────────┘             │
│                          │                                                  │
│                          ▼                                                  │
│    ┌─────────────────────────────────────────────────────────┐             │
│    │  Batch 2: 服务层                                        │             │
│    │    - 迁移 services                                      │             │
│    │    - 验证 + 皇上确认                                    │             │
│    └─────────────────────────────────────────────────────────┘             │
│                          │                                                  │
│                          ▼                                                  │
│                       ... 更多批次 ...                                      │
│                                                                             │
│  每批次规则:                                                                │
│    - 最多 30 文件                                                           │
│    - 必须验证通过才能继续                                                   │
│    - 失败必须回滚                                                           │
│    - 每批次皇上确认                                                         │
│                                                                             │
│  Step 4: Test Agent 全面验收                                               │
│                                                                             │
│  Step 5: Review + 交付                                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 优化循环详解（配合 Ralph Wiggum）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       双阶段优化循环                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【阶段一：完成循环】                                                        │
│  ═══════════════════                                                        │
│  目标: 功能正确                                                             │
│  标准: 编译通过 + 测试通过                                                  │
│  max_iterations: 20                                                         │
│                                                                             │
│    ┌────────────────────────────────────────────────────────┐              │
│    │                                                        │              │
│    │   Code Agent 写代码                                    │              │
│    │       │                                                │              │
│    │       ▼                                                │              │
│    │   【真实执行】                                         │              │
│    │     - tsc --noEmit                                    │              │
│    │     - npm test                                        │              │
│    │       │                                                │              │
│    │       ├── 通过 → 进入阶段二                           │              │
│    │       │                                                │              │
│    │       └── 失败 → 分析 → 修复 → 再循环                 │              │
│    │                                                        │              │
│    └────────────────────────────────────────────────────────┘              │
│                          │                                                  │
│                          ▼ 阶段一完成                                       │
│                                                                             │
│  【阶段二：优化循环】                                                        │
│  ═══════════════════                                                        │
│  目标: 质量提升                                                             │
│  标准: 可量化指标达标                                                       │
│  max_iterations: 10                                                         │
│                                                                             │
│    ┌────────────────────────────────────────────────────────┐              │
│    │                                                        │              │
│    │   优化目标（可量化）:                                  │              │
│    │     - 测试覆盖率 ≥ 80%                                │              │
│    │     - ESLint 警告 = 0                                 │              │
│    │     - 代码重复率 ≤ 5%                                 │              │
│    │       │                                                │              │
│    │       ▼                                                │              │
│    │   【真实测量】                                         │              │
│    │     - npm test --coverage                             │              │
│    │     - npx eslint .                                    │              │
│    │     - npx jscpd .                                     │              │
│    │       │                                                │              │
│    │       ├── 达标 → 完成                                 │              │
│    │       │                                                │              │
│    │       └── 未达标 → 优化 → 再测量                      │              │
│    │                                                        │              │
│    └────────────────────────────────────────────────────────┘              │
│                                                                             │
│  安全机制:                                                                  │
│    - 契约层保护: 优化不能破坏契约                                          │
│    - 全量编译: 每次优化后全项目编译                                        │
│    - 边际收益: 连续 3 次无提升则停止                                       │
│    - 卡住上报: 超过 max_iterations 上报皇上                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔒 契约层保护机制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       契约层 vs 实现层                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        契约层 🔒                                     │   │
│  │                                                                     │   │
│  │  设计时机: Spec Agent 阶段（设计草案）                              │   │
│  │  实现时机: Code Agent Phase A（实现并验证）                         │   │
│  │  锁定时机: Code Agent 实现通过编译验证 + 皇上确认后                 │   │
│  │                                                                     │   │
│  │  内容:                                                              │   │
│  │    - interface User { id, name, email }                            │   │
│  │    - function getUser(id: string): Promise<User>  ← 签名           │   │
│  │    - POST /api/users  ← 路由                                       │   │
│  │    - users 表结构  ← 数据模型                                      │   │
│  │                                                                     │   │
│  │  验证方式: npx tsc --noEmit 真实编译通过                            │   │
│  │  规则: 🔒 不可擅自修改，改必奏请皇上                                │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        实现层 🔓                                     │   │
│  │                                                                     │   │
│  │  定义时机: Code Agent Phase B（契约锁定后）                         │   │
│  │                                                                     │   │
│  │  内容:                                                              │   │
│  │    - function getUser(id: string): Promise<User> {                 │   │
│  │        // 👇 这里面的代码可以自由优化                              │   │
│  │        const cached = cache.get(id);  // 加缓存                    │   │
│  │        if (cached) return cached;                                  │   │
│  │        const user = await db.users.findById(id);                   │   │
│  │        cache.set(id, user);                                        │   │
│  │        return user;                                                │   │
│  │      }                                                             │   │
│  │                                                                     │   │
│  │  规则: 🔓 在契约不变前提下，可自由优化                              │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  契约锁定流程（新）:                                                        │
│  ──────────────────                                                         │
│                                                                             │
│    Spec Agent 设计契约草案                                                  │
│         │                                                                   │
│         ▼                                                                   │
│    Code Agent Phase A 实现契约代码                                         │
│         │                                                                   │
│         │  - shared 契约 → 验证 → ✅                                       │
│         │  - backend 契约 → 验证 → ✅                                      │
│         │  - 各端契约 → 验证 → ✅                                          │
│         │                                                                   │
│         ▼                                                                   │
│    全部编译通过（npx tsc --noEmit）                                        │
│         │                                                                   │
│         ▼                                                                   │
│    皇上确认 → 🔒 契约锁定                                                  │
│         │                                                                   │
│         ▼                                                                   │
│    Code Agent Phase B 实现具体功能                                         │
│                                                                             │
│  契约变更流程:                                                              │
│  ─────────────                                                              │
│                                                                             │
│    发现需要改契约                                                           │
│         │                                                                   │
│         ▼                                                                   │
│    停止工作 → 上报皇上                                                     │
│         │                                                                   │
│         │  "启奏皇上：发现 User.email 应改为可选，                         │
│         │   影响 backend + web，请皇上定夺"                                │
│         │                                                                   │
│         ▼                                                                   │
│    等待许可                                                                 │
│         │                                                                   │
│         ├── 皇上批准 → 修改契约 + 史官记录 + 通知受影响模块               │
│         │                                                                   │
│         └── 皇上拒绝 → 维持原契约，想其他办法                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 完整时序图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                  Orchestra 完整时序图                                    │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  皇上        Plan        Spec        Code        Test       Review      钦天监  将作监  史官
│   │          Agent       Agent       Agent       Agent      Agent         │      │      │
│   │            │           │           │           │          │           │      │      │
│   │──"新项目"─▶│           │           │           │          │           │      │      │
│   │            │           │           │           │          │           │      │      │
│   │            │───────────────────────────────────────────────────────────────────────▶│
│   │            │                                              start_project()           │
│   │            │◀──────────────────────────────────────────────────────────────────────│
│   │            │                                                          project_id    │
│   │◀──"需求？"─│           │           │           │          │           │      │      │
│   │──"功能..."─▶│          │           │           │          │           │      │      │
│   │◀──确认？───│           │           │           │          │           │      │      │
│   │──"✅确认"─▶│           │           │           │          │           │      │      │
│   │            │           │           │           │          │           │      │      │
│   │            │──Plan────▶│           │           │          │           │      │      │
│   │            │  Report   │           │           │          │           │      │      │
│   │            │           │           │           │          │           │      │      │
│   │            │           │───────────────────────────────────────────────────▶│      │
│   │            │           │                                  plan_modules()    │      │
│   │            │           │◀──────────────────────────────────────────────────│      │
│   │            │           │                                       模块树       │      │
│   │            │           │           │           │          │           │      │      │
│   │◀───────────────────────│           │           │          │           │      │      │
│   │        "契约层设计，请确认"        │           │          │           │      │      │
│   │──"✅确认"──────────────▶│          │           │          │           │      │      │
│   │            │           │           │           │          │           │      │      │
│   │            │           │──Tech────▶│           │          │           │      │      │
│   │            │           │  Spec     │           │          │           │      │      │
│   │            │           │  (🔒)     │           │          │           │      │      │
│   │            │           │           │           │          │           │      │      │
│   │            │           │           │─────────────────────────────────▶│      │      │
│   │            │           │           │                     check_naming()      │      │
│   │            │           │           │◀────────────────────────────────│      │      │
│   │            │           │           │           │          │           │      │      │
│   │            │           │           │  [开发循环]          │           │      │      │
│   │            │           │           │  写代码              │           │      │      │
│   │            │           │           │  tsc + test          │           │      │      │
│   │            │           │           │  通过?               │           │      │      │
│   │            │           │           │           │          │           │      │      │
│   │            │           │           │───────────────────────────────────▶│     │      │
│   │            │           │           │                      scan_project()     │      │
│   │            │           │           │◀──────────────────────────────────│     │      │
│   │            │           │           │           │          │           │      │      │
│   │            │           │           │──代码────▶│          │           │      │      │
│   │            │           │           │           │          │           │      │      │
│   │            │           │           │           │ [五层验收]│           │      │      │
│   │            │           │           │           │  编译     │           │      │      │
│   │            │           │           │           │  单元测试 │           │      │      │
│   │            │           │           │           │  集成测试 │           │      │      │
│   │            │           │           │           │──────────────────────▶│      │      │
│   │            │           │           │           │         scan_project()│      │      │
│   │            │           │           │           │◀─────────────────────│      │      │
│   │            │           │           │           │  规格符合 │           │      │      │
│   │            │           │           │           │          │           │      │      │
│   │            │           │           │    ┌──────┴──────┐   │           │      │      │
│   │            │           │           │    │             │   │           │      │      │
│   │            │           │           │◀──FAIL          PASS─▶│          │      │      │
│   │            │           │           │   修复循环       │   │          │      │      │
│   │            │           │           │                  │   │          │      │      │
│   │            │           │           │           │      │──测试报告──▶│      │      │
│   │            │           │           │           │          │          │      │      │
│   │◀──────────────────────────────────────────────────────────│          │      │      │
│   │                              "审查报告，请确认"           │          │      │      │
│   │──"✅通过"─────────────────────────────────────────────────▶│         │      │      │
│   │            │           │           │           │          │          │      │      │
│   │            │           │           │           │          │───────────────────────▶│
│   │            │           │           │           │          │       complete_project()│
│   │◀──────────────────────────────────────────────────────────│          │      │      │
│   │                              ✅ 项目完成                  │          │      │      │
│   │            │           │           │           │          │          │      │      │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## ✅ 检查清单

皇上可对照以下检查清单验证流程：

### 流程完整性
- [ ] Plan → Spec → Code → Test → Review 五阶段完整
- [ ] 每个阶段有明确输入输出
- [ ] 阶段间交接有明确产出物

### 契约层保护
- [ ] Spec Agent 定义契约层
- [ ] 皇上确认后锁定
- [ ] Code Agent 只读契约、实现细节
- [ ] 修改契约需皇上许可

### 辅助 Skill 集成
- [ ] 钦天监：扫描项目真实信息
- [ ] 将作监：规划模块、检查命名
- [ ] 史官：全程记录、留痕可查

### 验收机制
- [ ] 五层验收：编译 → 单测 → 集测 → 质量 → 规格
- [ ] 真实执行：tsc、npm test 真跑
- [ ] 失败打回：FAIL → Code Agent 修复

### 优化循环
- [ ] 双阶段：完成循环 + 优化循环
- [ ] 可量化指标：覆盖率、警告数等
- [ ] 安全机制：max_iterations、卡住上报

### 三种场景
- [ ] 新项目：完整五阶段
- [ ] 功能迭代：增量开发、回归测试
- [ ] 项目重塑：分批次、每批确认

---

**🎼 Orchestra 皇上使用手册 · 完**
